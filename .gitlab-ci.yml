image: ruby:latest

services:
  - docker:dind

variables:
  DOCKER_HOST: "tcp://docker:2375"
  KITCHEN_LOCAL_YAML: ".kitchen.dokken.yml"

before_script:
  - apt-get update -y
  - apt-get upgrade -y
  - ruby -v
  - apt-get install -y g++ # needed by unf_ext Gem
  - bundle config set --local without development
  - bundle install -j $(nproc)

cookstyle:
  script:
    - cookstyle

# XXX: cannot run on gitlab.com CI runners, we need to install our own instance
# to support libvirt or podman
# https://docs.gitlab.com/runner/executors/custom_examples/libvirt.html
# https://github.com/test-kitchen/kitchen-dokken/blob/main/documentation/PODMAN.md
kitchen:
  script:
    - kitchen list
    - kitchen test
